# Copilot StudioでOpenAPI仕様を取り込んでツールを登録する手順

このドキュメントでは、PLC Gateway APIをMicrosoft Copilot Studioに統合する詳細な手順を説明します。

## 目次

- [前提条件](#前提条件)
- [詳細手順](#詳細手順)
- [動作確認](#動作確認)
- [トラブルシューティング](#トラブルシューティング)
- [クイックリファレンス](#クイックリファレンス)

---

## 前提条件

### 必要なもの

- ✅ **Copilot Studioライセンス**
- ✅ **作成者レベルの資格情報**
- ✅ **Swagger 2.0形式のOpenAPI仕様ファイル**（`swagger.json`または`swagger.yaml`）
- ✅ **API認証情報**（該当する場合）

### 重要な注意事項

⚠️ **OpenAPI v3.xは自動的にv2に変換されますが、Swagger 2.0を直接使用することを推奨**

このプロジェクトでは、起動時に自動的に以下のファイルが生成されます：

- `openapi.json` / `openapi.yaml` - OpenAPI 3.1仕様
- `swagger.json` / `swagger.yaml` - **Swagger 2.0仕様（Copilot Studio用）** ← 推奨

---

## 詳細手順

### ステップ1: ツール追加画面を開く

1. **Copilot Studio**にアクセス（https://copilotstudio.microsoft.com/）
2. 対象の**エージェント**を選択
3. **概要ページ**の「ツール」セクションで **[ツールの追加]** をクリック
   - または **[ツール]** タブ → **[ツールの追加]** をクリック

### ステップ2: REST APIツールタイプを選択

1. **[新しいツール]** をクリック
2. **[REST API]** を選択

### ステップ3: OpenAPI仕様ファイルをアップロード

#### ファイルの準備

以下のいずれかの方法でSwagger 2.0仕様ファイルを取得します：

**方法A: 起動時に自動生成されたファイルを使用**

```bash
# サーバーを起動（自動的にswagger.jsonが生成される）
cd d:\dev\gateway
python main.py --rest-api
```

生成されたファイルの場所：
```
d:\dev\gateway\swagger.json
d:\dev\gateway\swagger.yaml
```

**方法B: 起動済みサーバーからダウンロード**

```bash
# JSON形式
curl "http://localhost:8000/api/openapi/swagger" -o swagger.json

# YAML形式
curl "http://localhost:8000/api/openapi/swagger/yaml" -o swagger.yaml
```

**方法C: ブラウザから直接ダウンロード**

サーバー起動後、以下のURLにアクセス：
- http://localhost:8000/api/openapi/swagger
- http://localhost:8000/api/openapi/swagger/yaml

#### Copilot Studioでのアップロード

1. **ファイルアップロード画面**が表示される
2. 以下のいずれかの方法でアップロード：
   - **ドラッグ&ドロップ**: `swagger.json`をドラッグ
   - **参照**: フォルダを参照して`swagger.json`を選択

⚠️ **注意**:
- ファイル形式は **JSON v2（Swagger 2.0）** が必要
- YAMLファイルも使用可能（`swagger.yaml`）

### ステップ4: API詳細を確認・編集

#### 自動入力される情報

- **タイトル**: "PLC Gateway API"
- **説明**: OpenAPI仕様から自動取得
- **バージョン**: "1.2.0"

#### 説明の編集（推奨）

AIが適切なタイミングでツールを呼び出せるように、詳細な説明を追加します：

```
三菱PLCとMCプロトコルで通信するためのGateway API。
PLCデバイス（D, W, R, ZR, X, Y, M）の読み取りをサポート。
単一デバイスまたは複数デバイスの一括読み取りが可能。

使用例：
- データレジスタ（D）の値を取得
- 入出力リレー（X, Y）の状態を確認
- 内部リレー（M）のビット状態を読み取り
- 複数デバイスを一度に読み取り
```

**説明のポイント**：
- ✅ 具体的な用途を記載
- ✅ 同義語を含める（例：「読み取り」「取得」「アクセス」）
- ✅ AIが適切なタイミングで呼び出せるように明確に記述
- ✅ 具体的な使用例を列挙

#### ソリューションの選択

- 適切なソリューションを選択（組織用のコネクタ管理）

### ステップ5: 認証を設定

#### このプロジェクトの場合（認証なし）

1. **認証方法**: **[なし (None)]** を選択
2. そのまま次へ進む

#### その他の認証オプション

本プロジェクトでは使用しませんが、参考までに：

**APIキー認証**：
- APIキー名を入力
- ベースURLを指定
- APIキー値を追加

**OAuth 2.0認証**：
- クライアントID
- クライアントシークレット
- 認証URL
- トークンURL
- スコープ

### ステップ6: APIツール（アクション）を選択

#### 利用可能なアクション

自動的に以下のアクションが検出されます：

| アクション名 | メソッド | 説明 | 推奨 |
|------------|---------|------|------|
| `read_device` | POST | 単一デバイス読み取り | ✅ 推奨 |
| `read_device_get` | GET | 単一デバイス読み取り（GET） | ⚠️ オプション |
| `batch_read_devices` | POST | 複数デバイス一括読み取り | ✅ 推奨 |
| `read_device_compat` | GET | 後方互換エンドポイント | ❌ 不要 |

#### 推奨設定

最低限、以下の2つのアクションを有効化することを推奨：

1. ✅ **`read_device`** - 基本的な読み取り機能
2. ✅ **`batch_read_devices`** - 複数デバイスの効率的な読み取り

#### 各アクションの設定

各アクションを選択すると、以下の情報を確認・編集できます：

**例：read_device**

```
名前: PLCデバイス読み取り

説明:
指定したPLCデバイスから値を読み取ります。
デバイス種別（D, M, X, Y等）とアドレスを指定して値を取得します。

使用例：
- D100を読み取る
- データレジスタ100番の値を取得
- デバイスD100から3ワード読み取り
```

**例：batch_read_devices**

```
名前: PLC複数デバイス一括読み取り

説明:
複数のPLCデバイスを一度に読み取ります。
異なる種類のデバイスを同時に取得できます。

使用例：
- D100、M200、X1Aを一括で読み取る
- 複数のデータレジスタとリレーを同時取得
```

#### パラメータの確認

各アクションのパラメータには既に説明が追加されています：

**read_device のパラメータ**：

| パラメータ | 説明 | 必須 |
|-----------|------|------|
| `device` | デバイス種別（D, W, R, ZR, X, Y, M） | ✅ |
| `addr` | デバイスアドレス（10進数または16進数） | ✅ |
| `length` | 読み取り長（ワード数またはビット数） | ✅ |
| `ip` | PLCのIPアドレス（省略時は環境変数使用） | ❌ |
| `port` | PLCのポート番号（省略時は環境変数使用） | ❌ |

**batch_read_devices のパラメータ**：

| パラメータ | 説明 | 必須 |
|-----------|------|------|
| `devices` | デバイス指定リスト（例: ["D100", "M200:3", "X1A"]） | ✅ |
| `ip` | PLCのIPアドレス（省略時は環境変数使用） | ❌ |
| `port` | PLCのポート番号（省略時は環境変数使用） | ❌ |

⚠️ **重要**: パラメータの説明が空白の場合は、手動で入力が必要です。

### ステップ7: レビューと公開

1. **設定内容を確認**：
   - ツール名
   - 選択したアクション
   - 認証設定
   - パラメータ設定

2. **[公開]** ボタンをクリック

3. 公開が完了すると、**ツール選択画面**に戻ります

### ステップ8: エージェントにツールを追加

1. 新しく作成したREST APIツールを**エージェントに追加**
2. エージェントの設定を保存
3. 検索バーを使用してツールを簡単に見つけることができます

---

## 動作確認

### テスト方法

1. **Copilot Studioのテストチャット**を開く

2. 以下のような質問を試す：

#### テスト例1: 単一デバイス読み取り

```
質問:
「PLCのD100レジスタの値を読み取って」

期待される動作:
→ read_device ツールが呼び出される
→ device="D", addr=100, length=1
→ 値が返される
```

#### テスト例2: 複数ワード読み取り

```
質問:
「デバイスD100から5個のワードを読み取ってください」

期待される動作:
→ read_device ツールが呼び出される
→ device="D", addr=100, length=5
→ 5つの値が配列で返される
```

#### テスト例3: 複数デバイス一括読み取り

```
質問:
「M200とX1Aとデータレジスタ300番の値を一括で取得して」

期待される動作:
→ batch_read_devices ツールが呼び出される
→ devices=["M200", "X1A", "D300"]
→ 各デバイスの値が返される
```

#### テスト例4: 自然な表現

```
質問:
「D100、D101、D102の値を教えて」

期待される動作:
→ batch_read_devices または read_device(addr=100, length=3)
→ 3つの値が返される
```

### デバッグ方法

**Copilot Studioのデバッグ機能**：

1. テストチャット画面で「デバッグ情報」を有効化
2. ツール呼び出しの詳細を確認：
   - どのツールが選択されたか
   - どのパラメータが渡されたか
   - レスポンスの内容

**PLC Gateway APIサーバー側のログ**：

```bash
# サーバーのログを確認
python main.py --rest-api

# ログ出力例
INFO:     127.0.0.1:xxxxx - "POST /api/read HTTP/1.1" 200 OK
```

---

## トラブルシューティング

### よくある問題と解決策

#### 1. 「無効なOpenAPI仕様」エラー

**症状**：
```
Error: Invalid OpenAPI specification
```

**原因**：
- OpenAPI 3.1仕様を使用している
- 仕様ファイルの構文エラー

**解決策**：
```bash
# ✅ Swagger 2.0形式を使用
curl "http://localhost:8000/api/openapi/swagger" -o swagger.json

# ❌ 間違い：OpenAPI 3.1を使用
curl "http://localhost:8000/api/openapi/json" -o openapi.json
```

#### 2. パラメータの説明が空白

**症状**：
- アップロード後、パラメータに説明がない
- 「説明を追加してください」というエラー

**解決策**：
- 各パラメータに手動で説明を追加
- 日本語で具体的な説明を記入
- 必須/オプションを明確にする

#### 3. ツールが呼び出されない

**症状**：
- 質問してもツールが実行されない
- AIが別の方法で回答しようとする

**解決策**：
- ✅ ツールの説明を詳細かつ明確に記述
- ✅ 同義語を含める（「読み取り」「取得」「アクセス」等）
- ✅ 具体的な使用例を追加
- ✅ 質問の表現を変えてみる

**良い説明の例**：
```
PLCデバイスから値を読み取ります。
データレジスタ、リレー、入出力の状態を取得できます。
D100の値を取得、M200のビット状態を確認、などの操作に使用します。
```

#### 4. 接続エラー

**症状**：
```
Error: Failed to connect to API
Connection timeout
```

**解決策**：
- ✅ REST APIサーバーが起動しているか確認
- ✅ URLが正しいか確認（`http://localhost:8000`等）
- ✅ ファイアウォール設定を確認
- ✅ サーバーのログを確認

**確認コマンド**：
```bash
# サーバーが起動しているか確認
curl "http://localhost:8000/api/openapi/status"

# PLCへの接続テスト
curl -X POST "http://localhost:8000/api/read" \
  -H "Content-Type: application/json" \
  -d '{"device": "D", "addr": 0, "length": 1}'
```

#### 5. パラメータのデータ型エラー

**症状**：
```
Error: Invalid parameter type
Expected integer, got string
```

**解決策**：
- パラメータの型定義を確認
- Swagger 2.0仕様で型が正しく定義されているか確認
- 必要に応じて手動で型を修正

#### 6. レスポンスの解釈エラー

**症状**：
- ツールは呼び出されるが、結果が正しく表示されない
- AIがレスポンスを理解できない

**解決策**：
- レスポンススキーマが正しく定義されているか確認
- `ReadResponse`モデルが適切に定義されているか確認
- サーバー側のレスポンス形式を確認

---

## クイックリファレンス

### プロジェクト情報

**プロジェクトディレクトリ**：
```
d:\dev\gateway\
```

**使用するファイル**：
```
📁 d:\dev\gateway\
  ├─ swagger.json  ← このファイルをCopilot Studioにアップロード（推奨）
  ├─ swagger.yaml  ← または、このファイル
  ├─ openapi.json  ← OpenAPI 3.1版（非推奨）
  └─ openapi.yaml  ← OpenAPI 3.1版（非推奨）
```

### サーバー起動コマンド

```bash
# ディレクトリ移動
cd d:\dev\gateway

# サーバー起動（REST API）
python main.py --rest-api

# サーバー起動（カスタムポート）
python main.py --rest-api --port 9000

# サーバー起動（REST API + MCPサーバー）
python main.py --rest-api --mcp-server
```

### ダウンロードURL

サーバー起動後、以下のURLからSwagger 2.0仕様をダウンロードできます：

```
# JSON形式
http://localhost:8000/api/openapi/swagger

# YAML形式
http://localhost:8000/api/openapi/swagger/yaml

# ステータス確認
http://localhost:8000/api/openapi/status
```

### 推奨する有効化アクション

| アクション | 優先度 | 説明 |
|-----------|--------|------|
| `read_device` | ✅ 必須 | 基本的な読み取り機能 |
| `batch_read_devices` | ✅ 必須 | 複数デバイス読み取り |
| `read_device_get` | ⚠️ オプション | GET方式での読み取り |
| `read_device_compat` | ❌ 不要 | 後方互換用（非推奨） |

### サポートデバイス一覧

| デバイス | 名称 | アドレス形式 | 例 |
|---------|------|-------------|---|
| D | データレジスタ | 10進数 | D100, D200:5 |
| W | リンクレジスタ | 10進数 | W100 |
| R | ファイルレジスタ | 10進数 | R100 |
| ZR | インデックスレジスタ | 10進数 | ZR100 |
| X | 入力リレー | 16進数 | X1A, X0FF0 |
| Y | 出力リレー | 16進数 | Y20, YH20 |
| M | 内部リレー | 10進数 | M200, M0x10 |

### デバイス指定形式

```
単一デバイス:
  D100        # データレジスタ100番
  M200        # 内部リレー200番
  X1A         # 入力リレー0x1A番（16進）

連続読み取り:
  D100:5      # D100から5ワード読み取り
  M200:3      # M200から3ビット読み取り

16進数表記:
  X1A         # 16進アドレス
  M0x10       # 16進プレフィックス
  YH20        # 16進H記法
```

### 環境変数（オプション）

```bash
# PLC接続設定
export PLC_IP=192.168.1.100      # PLCのIPアドレス（デフォルト: 127.0.0.1）
export PLC_PORT=5511             # PLCのポート番号（デフォルト: 5511）
export PLC_TIMEOUT_SEC=3.0       # タイムアウト秒数（デフォルト: 3.0）

# MCPサーバー設定
export MCP_LOG_LEVEL=INFO        # MCPログレベル（デフォルト: INFO）
```

---

## まとめ

### 実装手順のチェックリスト

- [ ] 1. サーバーを起動して`swagger.json`を生成
- [ ] 2. Copilot Studioでツール追加画面を開く
- [ ] 3. REST APIを選択
- [ ] 4. `swagger.json`をアップロード
- [ ] 5. API詳細の説明を編集（推奨）
- [ ] 6. 認証を「なし」に設定
- [ ] 7. アクションを選択（`read_device`, `batch_read_devices`）
- [ ] 8. 各アクションの説明を確認・編集
- [ ] 9. パラメータの説明を確認
- [ ] 10. 公開
- [ ] 11. エージェントにツールを追加
- [ ] 12. テストチャットで動作確認

### テストチェックリスト

- [ ] 単一デバイス読み取りが動作する
- [ ] 複数ワード読み取りが動作する
- [ ] 複数デバイス一括読み取りが動作する
- [ ] 異なるデバイス種別の読み取りが動作する
- [ ] エラー時の挙動が適切

### 成功のポイント

✅ **Swagger 2.0形式を使用**する
✅ **詳細な説明を記載**する
✅ **具体的な使用例を含める**する
✅ **必要最小限のアクションを選択**する
✅ **テストで動作確認**する

---

## 参考リンク

- [Microsoft Learn - REST APIからツールを使用してエージェントを拡張する](https://learn.microsoft.com/ja-jp/microsoft-copilot-studio/agent-extend-action-rest-api)
- [Microsoft 365 Copilot用API プラグイン](https://learn.microsoft.com/ja-jp/microsoft-365-copilot/extensibility/overview-api-plugins)
- [PLC Gateway API - README](./README.md)
- [PLC Gateway API - プロジェクトガイド](./CLAUDE.md)

---

**最終更新日**: 2025-01-20
**バージョン**: 1.0.0
**作成者**: PLC Gateway Development Team